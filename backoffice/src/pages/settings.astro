---
import Layout from '../layouts/Layout.astro';
import { getBotConfig } from '../lib/db';

const env = (Astro.locals as any).runtime?.env;
let config: any[] = [];

if (env?.DB) {
  config = await getBotConfig(env.DB);
}

const configLabels: Record<string, { label: string; description: string; type: string }> = {
  bot_name: { label: 'Nome Bot', description: 'Il nome del bot mostrato nei messaggi', type: 'text' },
  rate_limit_per_minute: { label: 'Rate Limit (per minuto)', description: 'Numero massimo di comandi per utente al minuto', type: 'number' },
  nsfw_default: { label: 'NSFW abilitato', description: 'Abilita comandi foto NSFW di default', type: 'toggle' },
  audio_default: { label: 'Audio abilitato', description: 'Abilita comandi audio di default', type: 'toggle' },
};
---

<Layout title="Impostazioni">
  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">⚙️ Impostazioni</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">Configurazione globale del bot</p>
    </div>

    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 divide-y divide-gray-100 dark:divide-gray-800">
      {config.map((item: any) => {
        const meta = configLabels[item.key];
        return (
          <div class="p-4 flex items-center justify-between" data-config-key={item.key}>
            <div>
              <div class="text-gray-900 dark:text-white font-medium text-sm">{meta?.label || item.key}</div>
              <div class="text-gray-400 dark:text-gray-500 text-xs mt-1">{meta?.description || `Chiave: ${item.key}`}</div>
            </div>
            <div class="flex items-center gap-3">
              {meta?.type === 'toggle' ? (
                <button
                  data-toggle-config={item.key}
                  data-value={item.value}
                  class={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                    item.value === 'true' ? 'bg-primary-600' : 'bg-gray-300 dark:bg-gray-600'
                  }`}
                >
                  <span
                    class={`inline-block h-4 w-4 rounded-full bg-white transition-transform ${
                      item.value === 'true' ? 'translate-x-6' : 'translate-x-1'
                    }`}
                  />
                </button>
              ) : (
                <div class="flex gap-2">
                  <input
                    type={meta?.type || 'text'}
                    value={item.value}
                    data-input-config={item.key}
                    class="px-3 py-1 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white text-sm w-48 focus:ring-2 focus:ring-primary-500 outline-none"
                  />
                  <button
                    data-save-config={item.key}
                    class="bg-primary-600 hover:bg-primary-700 text-white text-sm px-3 py-1 rounded-lg transition-colors"
                  >
                    Salva
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  </div>

  <script>
    // Toggle configs
    document.querySelectorAll('[data-toggle-config]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const key = btn.getAttribute('data-toggle-config');
        const currentValue = btn.getAttribute('data-value');
        const newValue = currentValue === 'true' ? 'false' : 'true';

        const res = await fetch('/api/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key, value: newValue }),
        });
        if (res.ok) window.location.reload();
      });
    });

    // Save text/number configs
    document.querySelectorAll('[data-save-config]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const key = btn.getAttribute('data-save-config');
        const input = document.querySelector(`[data-input-config="${key}"]`);
        const value = input.value;

        const res = await fetch('/api/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key, value }),
        });
        if (res.ok) {
          btn.textContent = 'Salvato!';
          setTimeout(() => btn.textContent = 'Salva', 2000);
        }
      });
    });
  </script>
</Layout>
